name: Build Static Ncat x86

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2019 # Nmap 源码对 VS2019 的兼容性最好
    steps:
       
      - name: Checkout Nmap Source
        run: |
          git clone --depth 1 https://github.com/nmap/nmap.git

      - name: Install Static OpenSSL via vcpkg
        run: |
          vcpkg install openssl:x86-windows-static

      - name: Fix Project Files Globally
        shell: pwsh
        run: |
          $vcpkgInclude = "C:/vcpkg/installed/x86-windows-static/include"
          $vcpkgLib = "C:/vcpkg/installed/x86-windows-static/lib"
          $npcapDir = "$(pwd)/nmap-mswin32-aux/Npcap"

          # --- 新增：定位并修复 applink.c ---
          # 在 vcpkg 的安装包目录中搜索 applink.c
          $applinkSrc = Get-ChildItem -Path "C:/vcpkg/buildtrees/openssl" -Filter "applink.c" -Recurse | Select-Object -First 1
          
          if ($applinkSrc) {
              # 创建 openssl 文件夹并复制进去，这样 #include <openssl/applink.c> 就能找到了
              $destDir = "$vcpkgInclude/openssl"
              if (!(Test-Path $destDir)) { mkdir $destDir }
              Copy-Item $applinkSrc.FullName -Destination "$destDir/applink.c"
              Write-Host "Successfully located and copied applink.c to $destDir"
          } else {
              Write-Warning "applink.c not found, creating a fallback dummy to prevent build failure..."
              # 如果实在找不到，可以创建一个空的，因为静态构建其实用不到它的逻辑
              $destDir = "$vcpkgInclude/openssl"
              if (!(Test-Path $destDir)) { mkdir $destDir }
              "/* fallback */" | Set-Content "$destDir/applink.c"
          }
          # --------------------------------

          # 修正所有 vcxproj (保持之前的逻辑)
          Get-ChildItem -Recurse *.vcxproj | ForEach-Object {
            $content = Get-Content $_.FullName
            $content = $content -replace '<RuntimeLibrary>MultiThreadedDLL</RuntimeLibrary>', '<RuntimeLibrary>MultiThreaded</RuntimeLibrary>'
            $content = $content -replace '<RuntimeLibrary>MultiThreadedDebugDLL</RuntimeLibrary>', '<RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>'
            $content = $content -replace '<AdditionalIncludeDirectories>', "<AdditionalIncludeDirectories>$vcpkgInclude;$npcapDir/Include;"
            $content = $content -replace '<AdditionalLibraryDirectories>', "<AdditionalLibraryDirectories>$vcpkgLib;$npcapDir/Lib/x86;"
            $content = $content -replace '<AdditionalDependencies>', "<AdditionalDependencies>libssl.lib;libcrypto.lib;crypt32.lib;ws2_32.lib;wpcap.lib;Packet.lib;advapi32.lib;user32.lib;gdi32.lib;"
            $content | Set-Content $_.FullName
          }

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Download Npcap SDK
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://npcap.com/dist/npcap-sdk-1.13.zip" -OutFile "npcap-sdk.zip"
          Expand-Archive -Path "npcap-sdk.zip" -DestinationPath "nmap-mswin32-aux/Npcap"
          # 注意：Nmap 源码默认寻找同级目录下的 nmap-mswin32-aux 文件夹

      - name: Build Ncat
        shell: cmd
        run: |
          cd nmap
          :: 编译整个 ncat 解决方案，确保依赖项同步编译
          :: 使用 /p:VcpkgTriplet 强制所有子项目识别静态库
          msbuild ncat/ncat.vcxproj /p:Configuration=Release /p:Platform=Win32 ^
          /p:VcpkgTriplet=x86-windows-static ^
          /p:VcpkgEnabled=true ^
          /p:IncludePath="C:\vcpkg\installed\x86-windows-static\include;$(IncludePath)" ^
          /p:LibraryPath="C:\vcpkg\installed\x86-windows-static\lib;$(LibraryPath)"

      - name: Check Executable Dependencies
        shell: pwsh
        run: |
          # 简单检查是否生成成功
          ls nmap/ncat/Release/ncat.exe

      - name: Upload Ncat Binary
        uses: actions/upload-artifact@v4
        with:
          name: ncat-static-x86
          path: nmap/ncat/Release/ncat.exe
