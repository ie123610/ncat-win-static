name: Build Static Ncat x86

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2019 # Nmap 源码对 VS2019 的兼容性最好
    steps:
       
      - name: Checkout Nmap Source
        run: |
          git clone --depth 1 https://github.com/nmap/nmap.git

      - name: Download Latest Npcap SDK
        shell: pwsh
        run: |
          $auxDir = "nmap-mswin32-aux"
          if (!(Test-Path $auxDir)) { New-Item -ItemType Directory -Path $auxDir }

          # 1. 抓取页面内容
          $baseUrl = "https://npcap.com/dist/"
          Write-Host "Fetching Npcap SDK list from $baseUrl"
          $response = Invoke-WebRequest -Uri $baseUrl -UseBasicParsing

          # 2. 提取所有满足格式的链接，并进行智能排序
          # 匹配模式：npcap-sdk- (数字.数字) .zip
          $latestSdk = $response.Links | 
              Where-Object { $_.href -match "npcap-sdk-([\d\.]+)\.zip" } | 
              Select-Object @{
                  Name = "Version"; 
                  Expression = { [version]($Matches[1]) } # 将字符串转为 Version 对象进行数值比较
              }, @{
                  Name = "FileName"; 
                  Expression = { $_.href }
              } | 
              Sort-Object Version -Descending | # 按版本号从大到小排序
              Select-Object -First 1           # 取最大的一个

          if (-not $latestSdk) {
              Write-Error "Could not find any valid Npcap SDK links."
              exit 1
          }

          $sdkFileName = $latestSdk.FileName
          Write-Host "Found latest version: $($latestSdk.Version). File: $sdkFileName"

          # 3. 下载并处理
          $downloadUrl = "$baseUrl$sdkFileName"
          Invoke-WebRequest -Uri $downloadUrl -OutFile "npcap-sdk.zip"
          
          # 解压
          Expand-Archive -Path "npcap-sdk.zip" -DestinationPath "$auxDir/temp"
          
          # 文件夹归一化：将 npcap-sdk-x.xx 重命名为 Npcap
          $extractedDir = Get-ChildItem "$auxDir/temp" | Where-Object { $_.PSIsContainer } | Select-Object -First 1
          $finalPath = "$auxDir/Npcap"
          if (Test-Path $finalPath) { Remove-Item $finalPath -Recurse -Force }
          Move-Item -Path $extractedDir.FullName -Destination $finalPath

          # 4. 清理
          Remove-Item "$auxDir/temp" -Recurse -Force
          Remove-Item "npcap-sdk.zip" -Force
          
          Write-Host "SUCCESS: Npcap SDK $($latestSdk.Version) is ready at $finalPath"
      
      - name: Install Static OpenSSL via vcpkg
        run: |
          vcpkg install openssl:x86-windows-static

      - name: Fix Project Files Globally
        shell: pwsh
        run: |
          $vcpkgInclude = "C:/vcpkg/installed/x86-windows-static/include"
          $vcpkgLib = "C:/vcpkg/installed/x86-windows-static/lib"
          $npcapDir = "$(pwd)/nmap-mswin32-aux/Npcap"

          # 1. 精准探测并物理搬运库 (保持现状)
          $sdkRoot = "C:\Program Files (x86)\Windows Kits\10\Lib"
          $latestSdk = Get-ChildItem -Path $sdkRoot -Filter "10.0.*" | Sort-Object Name -Descending | Select-Object -First 1
          $sdkLibDir = Join-Path $latestSdk.FullName "um\x86"
          $libsToCopy = @("ws2_32.lib", "crypt32.lib", "advapi32.lib", "iphlpapi.lib", "user32.lib", "gdi32.lib", "shell32.lib")
          foreach ($lib in $libsToCopy) {
              $src = Join-Path $sdkLibDir $lib
              if (Test-Path $src) { Copy-Item $src -Destination "$vcpkgLib\$lib" -Force }
          }

          # 2. 修正项目文件
          Get-ChildItem -Recurse *.vcxproj | ForEach-Object {
            $content = Get-Content $_.FullName
            # 静态链接 CRT
            $content = $content -replace '<RuntimeLibrary>MultiThreadedDLL</RuntimeLibrary>', '<RuntimeLibrary>MultiThreaded</RuntimeLibrary>'
            $content = $content -replace '<RuntimeLibrary>MultiThreadedDebugDLL</RuntimeLibrary>', '<RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>'
            
            # 注入路径和依赖
            $content = $content -replace '<AdditionalIncludeDirectories>', "<AdditionalIncludeDirectories>$vcpkgInclude;$npcapDir/Include;"
            $content = $content -replace '<AdditionalLibraryDirectories>', "<AdditionalLibraryDirectories>$vcpkgLib;$npcapDir/Lib/x86;"
            $content = $content -replace '<AdditionalDependencies>', "<AdditionalDependencies>libssl.lib;libcrypto.lib;wpcap.lib;Packet.lib;ws2_32.lib;crypt32.lib;advapi32.lib;iphlpapi.lib;shell32.lib;user32.lib;gdi32.lib;"
            
            
            $content | Set-Content $_.FullName
          }
          
          # 3. 修复 applink.c (保持现状)
          $applinkSrc = Get-ChildItem -Path "C:/vcpkg/buildtrees/openssl" -Filter "applink.c" -Recurse | Select-Object -First 1
          $destDir = "$vcpkgInclude/openssl"
          mkdir $destDir -ErrorAction SilentlyContinue
          if ($applinkSrc) { Copy-Item $applinkSrc.FullName -Destination "$destDir/applink.c" }
          else { "extern int _CRT_fmode; void _Applink(void) { (void)_CRT_fmode; }" | Set-Content "$destDir/applink.c" }

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Build Ncat
        shell: cmd
        run: |
          cd nmap
          msbuild ncat/ncat.vcxproj /p:Configuration=Release /p:Platform=Win32 ^
          /p:VcpkgTriplet=x86-windows-static ^
          /p:VcpkgEnabled=true ^
          /p:PostBuildEventUseInBuild=false
          
      - name: Check Executable Dependencies
        shell: pwsh
        run: |
          # 简单检查是否生成成功
          ls nmap/ncat/Release/ncat.exe

      - name: Upload Ncat Executable
        uses: actions/upload-artifact@v4
        with:
          name: ncat-static-win32
          path: nmap/ncat/Release/ncat.exe
